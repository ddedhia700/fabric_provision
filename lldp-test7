- name: Collect LLDP neighbor information
  hosts: switches
  gather_facts: no
  collections:
    - cisco.nxos
  tasks:
    - name: Gather LLDP neighbors
      cisco.nxos.nxos_command:
        commands: "show lldp neighbors | json"
      register: lldp_output
      delegate_facts: true

    - name: Parse LLDP JSON output and store links
      set_fact:
        lldp_links: "{{ lldp_output.stdout[0].TABLE_nbor.DETAIL | map('combine', {'local_interface': item.l_port_id, 'peer': item.sysname, 'peer_interface': item.port_id}) | list }}"
      when: lldp_output.stdout[0].TABLE_nbor is defined
      delegate_facts: true
      ignore_errors: yes  # Continue even if a host fails to provide LLDP data

- name: Aggregate LLDP and assign /31 subnets
  hosts: localhost
  gather_facts: no
  collections:
    - ansible.utils
  vars:
    main_subnet: "{{ main_subnet }}"
    counter_file: "{{ counter_file }}"
    lldp_output_file: "{{ lldp_output_file }}"
    host_subnet_file_prefix: "{{ host_subnet_file_prefix }}"
  tasks:
    - name: Check for hosts missing LLDP data
      set_fact:
        missing_lldp: "{{ groups['switches'] | reject('in', hostvars | dict2items | select('match', 'lldp_links', 'defined') | map(attribute='key') | list) | list }}"
      delegate_facts: true

    - name: Fail if any hosts are missing LLDP data
      fail:
        msg: "Hosts missing LLDP data: {{ missing_lldp | join(', ') }}"
      when: missing_lldp | length > 0

    - name: Aggregate LLDP links
      set_fact:
        host_lldp: "{{ hostvars | dict2items | select('match', 'lldp_links', 'defined') | combine({ item.key: item.value.lldp_links | map('combine', {'local_host': item.key}) | list }) }}"
      vars:
        combine: "{{ dict(hostvars | dict2items | select('match', 'lldp_links', 'defined') | map(attribute='key') | zip(hostvars | dict2items | select('match', 'lldp_links', 'defined') | map(attribute='value.lldp_links') | map('map', 'combine', {'local_host': item.key})) }}"
      delegate_facts: true

    - name: Write aggregated LLDP output to file
      copy:
        content: "{{ host_lldp | to_json }}"
        dest: "{{ lldp_output_file }}"
        mode: '0644'
      delegate_facts: true

    - name: Read current subnet index from file
      slurp:
        src: "{{ counter_file }}"
      register: index_file
      ignore_errors: yes

    - name: Initialize subnet index
      set_fact:
        subnet_index: "{{ (index_file.content | b64decode | default('0') | int) }}"
        link_subnets: {}
      delegate_facts: true

    - name: Build unique switch pairs
      set_fact:
        unique_pairs: "{{ unique_pairs | default([]) + [item | combine({'src': min(item.local_host, item.peer), 'dst': max(item.local_host, item.peer), 'src_interface': item.local_interface if item.local_host < item.peer else item.peer_interface, 'dst_interface': item.peer_interface if item.local_host < item.peer else item.local_interface})] }}"
      loop: "{{ host_lldp | dict2items | map(attribute='value') | flatten }}"
      delegate_facts: true

    - name: Check subnet capacity
      assert:
        that: "{{ (subnet_index | int) + (unique_pairs | length) <= 128 }}"
        fail_msg: "Not enough /31 subnets available in /24 (need {{ unique_pairs | length }}, available {{ 128 - (subnet_index | int) }})"

    - name: Assign subnets to unique pairs
      set_fact:
        link_subnets: "{{ link_subnets | combine({ item.src + '-' + item.dst: {'subnet': (main_subnet | ansible.utils.ipsubnet(31, subnet_index)), 'src_ip': (main_subnet | ansible.utils.ipsubnet(31, subnet_index) | ansible.utils.nthhost(1)), 'dst_ip': (main_subnet | ansible.utils.ipsubnet(31, subnet_index) | ansible.utils.nthhost(2)), 'src_interface': item.src_interface, 'dst_interface': item.dst_interface} }) }}"
        subnet_index: "{{ subnet_index | int + 1 }}"
      loop: "{{ unique_pairs | unique }}"
      delegate_facts: true

    - name: Save updated subnet index to file
      copy:
        content: "{{ subnet_index }}"
        dest: "{{ counter_file }}"
        mode: '0644'
      delegate_facts: true

    - name: Map subnets to hosts
      set_fact:
        host_subnets: "{{ host_subnets | default({}) | combine({ item.src: (host_subnets[item.src] | default([]) + [{'peer': item.dst, 'subnet': link_subnets[item.src + '-' + item.dst].subnet, 'ip': link_subnets[item.src + '-' + item.dst].src_ip, 'interface': link_subnets[item.src + '-' + item.dst].src_interface}] }) | combine({ item.dst: (host_subnets[item.dst] | default([]) + [{'peer': item.src, 'subnet': link_subnets[item.src + '-' + item.dst].subnet, 'ip': link_subnets[item.src + '-' + item.dst].dst_ip, 'interface': link_subnets[item.src + '-' + item.dst].dst_interface}] }) }}"
      loop: "{{ unique_pairs | unique }}"
      delegate_facts: true

    - name: Write per-host subnet assignments to files
      copy:
        content: "{{ host_subnets[item] | to_json }}"
        dest: "{{ host_subnet_file_prefix }}{{ item }}.json"
        mode: '0644'
      loop: "{{ host_subnets | dict2items | map(attribute='key') }}"
      delegate_facts: true

- name: Configure assigned subnets on switches
  hosts: switches
  gather_facts: no
  collections:
    - cisco.nxos
  tasks:
    - name: Print assigned subnets for this host
      debug:
        msg: "Host {{ inventory_hostname }} assigned links: {{ hostvars['localhost'].host_subnets[inventory_hostname] | default([]) }}"

    - name: Configure interfaces with assigned IPs
      cisco.nxos.nxos_config:
        lines:
          - "interface {{ item.interface }}"
          - "ip address {{ item.ip }}/31"
          - "no shutdown"
        save_when: modified
      loop: "{{ hostvars['localhost'].host_subnets[inventory_hostname] | default([]) }}"
      when: hostvars['localhost'].host_subnets[inventory_hostname] is defined
